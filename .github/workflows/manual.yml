name: LLM Conversation Bot

on: [push]

env:
  SUCCESS_FILE: /home/sergx/tmp/git-pull-success__llm_conv_bot.txt
  ERROR_FILE: /home/sergx/tmp/git-pull-error__llm_conv_bot.txt

jobs:
  run_ssh_command:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered."

      - name: Run scripts
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          password: ${{ secrets.PRODUCTION_PASSWORD }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            mkdir -p /home/sergx/tmp

            cd llm_conversations_bot || { echo "‚ùå Folder not found"; exit 1; }

            # Run git pull and capture stdout/stderr separately
            git pull >"$SUCCESS_FILE" 2>"$ERROR_FILE"

            sudo systemctl restart llm_conversations_bot.service

            send_telegram () {
              local message="$1"
              local max_length=4096
              while [ -n "$message" ]; do
                chunk="${message:0:max_length}"
                curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                  -d chat_id=${{ vars.TELEGRAM_CHAT_ID }} \
                  --data-urlencode text="$chunk"
                message="${message:max_length}"
              done
            }

            if [ -s "$ERROR_FILE" ]; then
              send_telegram "‚ùå Deployment failed\n$(cat "$ERROR_FILE")"
            fi

            if [ -s "$SUCCESS_FILE" ]; then
              send_telegram "‚úÖ Deployment success\n$(cat "$SUCCESS_FILE")"
            fi
