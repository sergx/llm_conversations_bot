name: LLM Conversation Bot

on: [push]


jobs:
  run_ssh_command:
    runs-on: ubuntu-latest
    env:
      SUCCESS_FILE: /home/sergx/tmp/git-pull-success__llm_conv_bot.txt
      ERROR_FILE: /home/sergx/tmp/git-pull-error__llm_conv_bot.txt
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered. $TEST_ENV"

      - name: Run scripts
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          password: ${{ secrets.PRODUCTION_PASSWORD }}
          port: ${{ secrets.PRODUCTION_PORT }}
          envs: SUCCESS_FILE,ERROR_FILE
          script: |
            mkdir -p /home/sergx/tmp
            
            rm -f "$SUCCESS_FILE" "$ERROR_FILE"

            cd llm_conversations_bot || { echo "âŒ Folder not found"; exit 1; }

            # Run git pull and capture stdout/stderr separately
            { git pull 2>&1 > "$SUCCESS_FILE" || echo "Git pull failed" > "$ERROR_FILE";} 

            sudo systemctl restart llm_conversations_bot.service

            send_telegram () {
              local message="$1"
              local max_length=4000   # slightly under 4096 to be safe
              local chunk=""

              # while [ -n "$message" ]; do
              #   # take first $max_length characters safely (UTF-8 aware)
              #   chunk=$(echo "$message" | head -c "$max_length")
              #   # send chunk
              #   curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              #     -d chat_id=${{ vars.TELEGRAM_CHAT_ID }} \
              #     --data-urlencode text="$chunk" \
              #     -d parse_mode=HTML
              #   # remove sent part from message
              #   message="${message:${#chunk}}"
              # done

              while [ -n "$message" ]; do
                chunk="${message:0:max_length}"
                curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                  -d chat_id=${{ vars.TELEGRAM_CHAT_ID }} \
                  -d text="$chunk"
                message="${message:max_length}"
              done
            }

            if [ -s "$ERROR_FILE" ]; then
              send_telegram $(cat "$ERROR_FILE")
            fi

            if [ -s "$SUCCESS_FILE" ]; then
              send_telegram $(cat "$SUCCESS_FILE")
            fi

